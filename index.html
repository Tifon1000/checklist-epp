<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist EPP Completo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-family: sans-serif;
            padding: 15px;
            font-size: 14px;
        }
        h2 { text-align: center; color: var(--tg-theme-button-color, #2481cc); }
        h4 { margin-top: 20px; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="date"], textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;
            box-sizing: border-box;
        }
        
        .empleado-item { margin: 5px 0; display: flex; align-items: center; }
        .empleado-item input { margin-right: 10px; transform: scale(1.2); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background-color: #e0e0e0; padding: 8px; text-align: center; font-size: 12px; color: #000;}
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .item-name { width: 40%; font-weight: 500; }
        .opt-col { text-align: center; width: 20%; }
        
        input[type="radio"].status { transform: scale(1.3); cursor: pointer; }
    </style>
</head>
<body>

    <h2>üõ°Ô∏è Estado de Equipo EPP</h2>

    <div class="form-group">
        <label>Fecha de revisi√≥n:</label>
        <input type="date" id="fecha">
    </div>

    <h4>üë§ Seleccione su nombre:</h4>
    <div id="lista-empleados">
    </div>

    <form id="form-epp">
        <h4>ü¶∫ EPP Asignado - 001 (B√°sico)</h4>
        <table id="tabla-001"><tr><th>√çtem</th><th>OK</th><th>Mal Estado</th><th>No Tengo</th></tr></table>

        <h4>üß§ EPP Asignado - 002 (Espec√≠fico)</h4>
        <table id="tabla-002"><tr><th>√çtem</th><th>OK</th><th>Mal Estado</th><th>No Tengo</th></tr></table>

        <h4>‚ò£Ô∏è EPP Asignado - 003 (Respiratorio)</h4>
        <table id="tabla-003"><tr><th>√çtem</th><th>OK</th><th>Mal Estado</th><th>No Tengo</th></tr></table>

        <h4>üèóÔ∏è Trabajos en Altura / Otros</h4>
        <table id="tabla-004"><tr><th>√çtem</th><th>OK</th><th>Mal Estado</th><th>No Tengo</th></tr></table>

        <h4>üìù Comentarios (Opcional)</h4>
        <textarea id="comentarios" rows="3" placeholder="Observaciones adicionales..."></textarea>
    </form>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("ENVIAR REPORTE");
        tg.MainButton.show();

        // 1. Configurar Fecha de hoy
        document.getElementById('fecha').valueAsDate = new Date();

        // 2. Datos
        const empleados = [
            "Alberto Hernandez Alvarado - 401661",
            "Alexis Dominguez Ontiveros - 402588",
            "Enrique L√°zaro Perez - 402401",
            "Jesus Antonio Martinez Peralta - 402581",
            "Jesus Mario Ascencio Enriquez - Pendiente",
            "Luis Alberto Martinez Cruz - 402582",
            "Octavio Elizalde Trujillo - 401145",
            "Adrian Hernandez Pastrana - 200510",
            "Jose Gregorio Valdez Rangel - 200507",
            "Marcos Miranda Rodriguez - 200763"
        ];

        const gruposEPP = {
            "tabla-001": ["Casco de Seguridad", "Lente de Seguridad", "Camisola", "Playera", "Chaleco", "Guante de Piel", "Pantal√≥n", "Calzado de Seguridad"],
            "tabla-002": ["L√°mpara manos libres", "Tapones para o√≠do", "Protector de cuello", "Capucha de Algod√≥n", "Traje Tyvek", "Traje Impermeable", "Guantes de carnaza", "Faja tipo pesista", "Bota industrial hule"],
            "tabla-003": ["Mascarilla media cara", "Cartucho gases/vapores"],
            "tabla-004": ["Rodilleras", "Arn√©s de Seguridad", "L√≠nea de Vida"] 
        };

        // 3. Generar HTML
        const containerEmp = document.getElementById('lista-empleados');
        empleados.forEach((emp, index) => {
            let div = document.createElement('div');
            div.className = 'empleado-item';
            div.innerHTML = `<input type="radio" name="empleado" value="${emp}" id="emp${index}"> <label for="emp${index}">${emp}</label>`;
            containerEmp.appendChild(div);
        });

        // Calculamos cu√°ntas preguntas totales hay para validar despu√©s
        let totalPreguntasEPP = 0;

        for (let [tablaId, items] of Object.entries(gruposEPP)) {
            let table = document.getElementById(tablaId);
            totalPreguntasEPP += items.length; // Sumamos al contador total

            items.forEach(item => {
                let row = table.insertRow();
                row.innerHTML = `<td class="item-name">${item}</td>`;
                let safeName = item.replace(/\s+/g, '_'); 
                row.innerHTML += `
                    <td class="opt-col"><input type="radio" class="status" name="${safeName}" value="OK"></td>
                    <td class="opt-col"><input type="radio" class="status" name="${safeName}" value="MAL_ESTADO"></td>
                    <td class="opt-col"><input type="radio" class="status" name="${safeName}" value="NO_TENGO"></td>
                `;
            });
        }

        // 4. L√≥gica de Env√≠o CON VALIDACI√ìN ESTRICTA
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            
            // --- VALIDACI√ìN 1: FECHA ---
            if (!document.getElementById("fecha").value) {
                Telegram.WebApp.showPopup({ title: 'Falta Fecha', message: '‚ùå La fecha es obligatoria.' });
                return;
            }

            // --- VALIDACI√ìN 2: NOMBRE ---
            let empSeleccionado = document.querySelector('input[name="empleado"]:checked');
            if (!empSeleccionado) {
                Telegram.WebApp.showPopup({ title: 'Falta Nombre', message: '‚ùå Selecciona tu nombre.' });
                return;
            }

            // --- VALIDACI√ìN 3: TABLAS COMPLETAS (NUEVO) ---
            // Contamos cu√°ntos radios est√°n marcados
            let respuestasMarcadas = document.querySelectorAll('input.status:checked').length;
            
            // Si las respuestas son menos que las preguntas, falta algo
            if (respuestasMarcadas < totalPreguntasEPP) {
                let faltantes = totalPreguntasEPP - respuestasMarcadas;
                Telegram.WebApp.showPopup({ 
                    title: 'Formulario Incompleto', 
                    message: `‚ùå Te falta revisar ${faltantes} equipos.\n\nTodo el EPP es obligatorio.` 
                });
                return; // Detenemos todo aqu√≠
            }

            try {
                let reporteEPP = {};
                document.querySelectorAll('input.status:checked').forEach(radio => {
                    let nombreReal = radio.name.replace(/_/g, ' '); 
                    reporteEPP[nombreReal] = radio.value;
                });

                let datos = {
                    fecha: document.getElementById("fecha").value,
                    empleado: empSeleccionado.value,
                    epp: reporteEPP,
                    comentarios: document.getElementById("comentarios").value // Esto s√≠ puede ir vac√≠o
                };

                // ENVIAR (CON M√âTODO DE SEGURIDAD PARA ANDROID)
                tg.sendData(JSON.stringify(datos)); 
                
                Telegram.WebApp.showPopup({
                    title: '‚úÖ Enviado',
                    message: 'Datos completos y enviados.\nPresiona OK para salir.',
                    buttons: [{type: 'ok', id: 'btn_cerrar'}]
                }, function(buttonId) {
                    if (buttonId === 'btn_cerrar') tg.close();
                });

            } catch (error) {
                Telegram.WebApp.showPopup({ title: 'Error', message: error.message });
            }
        });
    </script>
</body>
</html>
